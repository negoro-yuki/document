# 目次

- [目次](#目次)
- [はじめに](#はじめに)
- [用語](#用語)
- [開発](#開発)
  - [1. <font color="blue">ローカル</font>環境を用意する](#1-font-colorblueローカルfont環境を用意する)
  - [2. <font color="blue">ローカル</font>環境で開発する](#2-font-colorblueローカルfont環境で開発する)
- [別環境への更新](#別環境への更新)
  - [1. ソースの更新をする場合(local→review)](#1-ソースの更新をする場合localreview)
  - [4. レコードの更新をする場合](#4-レコードの更新をする場合)

# はじめに
    この資料は、FBWMSのSQLデータベースに対するプログラム更新やレコード更新を行う上で守るべき手順です。
    2021-03-01以降に作成されたデータベース開発を行う上での資料となり、それ以前の案件には適用しない資料となります。

# 用語
 
|資料内の呼び名|ソフトウェア|
|---|---|
|ADS|Azure Data Studio|
|SSMS|SQL Server Management Studio|

|資料内の呼び名|ブランチ|対象DB|Git|Jenkins|補足|
|---|---|---|---|---|---|
|<font color="red">本番</font>|master|WMS|手動|自動||
|<font color="Orange">最新</font>|review|WMS_TEST|プルリク|自動|最新ソース兼レビュー環境|
|<font color="blue">ローカル</font>|任意のチケット番号|WMS_○○|プルリク|手動|個人のローカル環境|
|<font color="green">教育</font>|education|WMS_EDU|手動|手動|現場教育用||<font color="green">教育</font>|education|WMS_EDU|手動|手動|現場教育用|


---
# 開発

## 1. <font color="blue">ローカル</font>環境を用意する 
**概要**

> 開発環境は他の開発者やレビューする人に影響しないよう、自分のみが使用する環境を用意します。

DB作成手順
1. 開発環境にDBを作成します。名称は個人が特定できる名前にしてください。  
例:WMS_NEGO

2. <font color="Orange">最新</font>環境のDBから作成したDBへ復元してください。

Git作成手順
1. 対象案件のリポジトリのクローンを作成します。
   
2. チケット番号毎にブランチを切ります。


補足
* SSMS・ADSどちらを使用してもよいです。
* 復元はSSMSの方が時間指定やファイル選択が優れているのでやりやすいです。

## 2. <font color="blue">ローカル</font>環境で開発する
概要
> 自分のDBに対して要件に必要な改修を行います。  
> ADS・SSMSいずれを使用して開発してもよいです。  
> 下記ルールは守ってください。

ルール
> ストアドを作成する場合
>> 1. 作成したストアドには **USP_L_Script** を使用してできるログを入力してください。
>> 1. 案件特有の要件についてはストアド名にDB名を入れてください。  
>> **USP_GET_Useful_Script** にメモ書きがあるのでそれを参考につけてください。 
>> 
>> 1. 画面でメッセージを出す場合の変数は、@Retと@RetMsgにしてください。
>> 1. insert/update/delete/mergeはUSP_CMD系のストアドを使用してください。
>> 1. メインテーブルへの更新は必ずトランザクションをかけてください。
>> 1. ワークテーブルへの更新ではトランザクションをかけないでください。
>> 1. ワークテーブルを作成しないようにJsonで渡せるように設計するのが吉です。

> テーブルを作成する場合
>> 1. 案件特有の要件についてはテーブル名にDB名を入れてください。
>> 1. 必ず主キーをつけてください。
>> 1. テーブル名称の頭文字は下記を参考に決めてください。
>>> |頭文字|意味|内容|注意点|補足|
>>> |---|---|---|---|---|
>>> |M|マスター(Master)|特定の作業に必要となるマスタテーブル|顧客と取引先を意識して設計してください。||
>>> |T|取引記録(Transactioni)|特定の作業に必要となるトランザクションテーブル|基準のテーブルに存在する主キーをベースに設計してください。||
>>> |R|帳票(Report)|帳票を出力する為のキー保管テーブル|基準のテーブルに存在する主キーをベースに設計してください。||
>>> |W|作業(Work)|処理途中ので途中段階の情報を保持するテーブル|PC_NMとWork_CDを入れてください。|処理前もしくは後には削除されるようストアドでコーディングしてください。|
>>> |H|履歴(History)|処理結果を保管しておくテーブル|基本はUSP_CMDにレコードログが存在しているので、直接このテーブルを参照するようなもの以外はむやみに作成しないでください。||


補足
* ストアド開発は **[USP_GET_Useful_Script]** の **開発コーディング支援** を有効活用して下さい。
![](image/USP_GET_Useful_Script開発コーディング支援.jpg)
* テストは **[USP_GET_Useful_Script]** の **開発コーディング支援** を有効活用して下さい。
![](image/USP_GET_Useful_Scriptデータステータスアップ.jpg)


# 別環境への更新
## 1. ソースの更新をする場合(local→review)
概要
> 開発が完了した後、ソースレビュー担当者へ渡す手順です。
> 
手順  
> 1. ADSのスキーマ比較で自分のDBとワークスペースの同期を取ります。
> 2. ADSでビルドして、エラーが無いことを確認します。
> 3. コメントを入力してコミット、プッシュします。
> 4. プルリクを作成します。

## 4. レコードの更新をする場合
概要

<font color="blue">ローカル</font>以外のDBに対して、レコードの追加や更新等を行う場合は、予め更新するためのレコードを更新する為のテーブルに保管しておきます。  
デイリータスクで未明に実行され、本番への更新がかかります。

ルール
* USP_GET_Useful_Scriptの用途 **データ作成** の **レコード内容変更用テーブル実行内容チェック** を使用して、更新エビデンスをRedmineに残します。
* USP_GET_Useful_Scriptの用途 **データ作成** の **レコード内容変更用テーブルへインサート** を使用して、更新対象DBのW_Upsert_Recordにインサートしてください。

補足
* USP_GET_Useful_Scriptにもコメントがありますが、すぐに更新したい場合、 **USP_JOB_Upsert_Tables** を実行する必要があります。
